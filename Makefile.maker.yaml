# Configuration file for <https://github.com/ironcore-dev/network-operator>

metadata:
  url: https://github.com/ironcore-dev/network-operator

binaries:
  - name: network-operator
    fromPackage: ./cmd
    installTo: bin/

controllerGen:
  enabled: true
  crdOutputPath: config/crd/bases
  objectHeaderFile: hack/boilerplate.go.txt
  rbacRoleName: manager-role

coverageTest:
  only: "/internal"

dockerfile:
  enabled: false

golang:
  setGoModVersion: true

golangciLint:
  createConfig: true
  skipDirs:
    - internal/provider/openconfig
  timeout: 10m

goReleaser:
  createConfig: true

reuse:
  enabled: false

renovate:
  enabled: true
  assignees:
    - felix-kaestner

testPackages:
  except: '/test'

githubWorkflow:
  global:
    defaultBranch: main
  ci:
    enabled: true
    prepareMakeTarget: generate
  license:
    enabled: true
  release:
    enabled: true
  securityChecks:
    enabled: true

variables:
  GO_BUILDENV: 'CGO_ENABLED=0'

verbatim: |
  # Image to use all building/pushing image targets
  IMG ?= controller:latest

  # CONTAINER_TOOL defines the container tool to be used for building images.
  # The default is docker, but it can be overridden to use other tools (i.e. podman or nerdctl).
  CONTAINER_TOOL ?= docker

  # KIND_CLUSTER defines the name of the Kind cluster to be used for the tilt setup.
  KIND_CLUSTER ?= network

  install-gofumpt: FORCE
    @if ! hash gofumpt 2>/dev/null; then printf "\e[1;36m>> Installing gofumpt...\e[0m\n"; go install mvdan.cc/gofumpt@latest; fi

  install-kustomize: FORCE
    @if ! hash kustomize 2>/dev/null; then printf "\e[1;36m>> Installing kustomize...\e[0m\n"; go install sigs.k8s.io/kustomize/kustomize/v5@latest; fi

  fmt: FORCE install-gofumpt
    @printf "\e[1;36m>> gofumpt -l -w .\e[0m\n"
    @gofumpt -l -w $(shell git ls-files '*.go' | grep -v '^internal/provider/openconfig')

  # Run the e2e tests against a k8s cluster.
  test-e2e: FORCE
    @command -v kind >/dev/null 2>&1 || { \
      echo "Kind is not installed. Please install Kind manually."; \
      exit 1; \
    }
    @kind get clusters | grep -q $(KIND_CLUSTER) || { \
      echo "No Kind cluster is running. Please start a Kind cluster before running the e2e tests."; \
      exit 1; \
    }
    @printf "\e[1;36m>> go test ./test/e2e/ -v -ginkgo.v\e[0m\n"
    @KIND_CLUSTER=$(KIND_CLUSTER) go test ./test/e2e/ -v -ginkgo.v

  docker-build: FORCE
    @printf "\e[1;36m>> $(CONTAINER_TOOL) build --tag=$(IMG) .\e[0m\n"
    @$(CONTAINER_TOOL) build --build-arg=BININFO_BUILD_DATE=$(BININFO_BUILD_DATE) --build-arg=BININFO_COMMIT_HASH=$(BININFO_COMMIT_HASH) --build-arg=BININFO_VERSION=$(BININFO_VERSION) --tag=$(IMG) .

  docker-push: FORCE
    @printf "\e[1;36m>> $(CONTAINER_TOOL) push $(IMG)\e[0m\n"
    @$(CONTAINER_TOOL) push $(IMG)

  # Generate a consolidated YAML with CRDs and deployment.
  build-installer: FORCE generate install-kustomize
    @printf "\e[1;36m>> kustomize build config/default > dist/install.yaml\e[0m\n"
    @cd config/manager && kustomize edit set image controller=$(IMG)
    @mkdir -p build; kustomize build config/default > dist/install.yaml

  # Deploy controller to the k8s cluster
  deploy: FORCE generate install-kustomize
    @printf "\e[1;36m>> kustomize build config/default | kubectl apply -f -\e[0m\n"
    @cd config/manager && kustomize edit set image controller=$(IMG)
    @kustomize build config/default | kubectl apply -f -

  # Undeploy controller from the k8s cluster
  undeploy: FORCE install-kustomize
    @printf "\e[1;36m>> kustomize build config/default | kubectl delete -f -\e[0m\n"
    @kustomize build config/default | kubectl delete --ignore-not-found=true -f -

  # Install CRDs into the k8s cluster
  deploy-crds: FORCE generate install-kustomize
    @printf "\e[1;36m>> kustomize build config/crd | kubectl apply -f -\e[0m\n"
    @kustomize build config/crd | kubectl apply -f -

  # Uninstall CRDs from the k8s cluster
  undeploy-crds: FORCE install-kustomize
    @printf "\e[1;36m>> kustomize build config/crd | kubectl delete -f -\e[0m\n"
    @kustomize build config/crd | kubectl delete --ignore-not-found=true -f -

  # Create a Kind cluster for local development and testing.
  kind-create: FORCE
    @command -v kind >/dev/null 2>&1 || { \
      echo "Kind is not installed. Please install Kind manually."; \
      exit 1; \
    }
    @kind get clusters | grep -q $(KIND_CLUSTER) || { \
      printf "\e[1;36m>> kind create cluster --name=$(KIND_CLUSTER)\e[0m\n"; \
      kind create cluster --name=$(KIND_CLUSTER); \
    }

  # Delete the Kind cluster created for local development and testing.
  kind-delete: FORCE
    @command -v kind >/dev/null 2>&1 || { \
      echo "Kind is not installed. Please install Kind manually."; \
      exit 1; \
    }
    @printf "\e[1;36m>> kind delete cluster --name=$(KIND_CLUSTER)\e[0m\n"
    @kind delete cluster --name=$(KIND_CLUSTER)

  tilt-up: FORCE kind-create
    @command -v tilt >/dev/null 2>&1 || { \
      echo "Tilt is not installed. Please install Tilt manually."; \
      exit 1; \
    }
    @printf "\e[1;36m>> tilt up --context kind-$(KIND_CLUSTER)\e[0m\n"
    @tilt up --context kind-$(KIND_CLUSTER)

  # Generate manifests e.g. CRD, RBAC etc.
  charts: FORCE generate
    @printf "\e[1;36m>> kubebuilder edit --plugins=helm/v1-alpha\e[0m\n"
    @mkdir dist && mv charts/network-operator dist/chart
    @kubebuilder edit --plugins=helm/v1-alpha
    @mv dist/chart charts/network-operator && rm -rf dist

  netop-provider:
    @printf "\e[1;36m>> go build -o build/netop-provider ./hack/provider\e[0m\n"
    @go build -o build/netop-provider ./hack/provider
    @printf "\e[1;36m>> ./build/netop-provider --help\e[0m\n"
    @./build/netop-provider --help

  TEST_SERVER_IMG ?= ghcr.io/ironcore-dev/gnmi-test-server:latest

  docker-build-test-gnmi-server: FORCE
    @printf "\e[1;36m>> $(CONTAINER_TOOL) build --tag=$(TEST_SERVER_IMG) ./test/gnmi\e[0m\n"
    @$(CONTAINER_TOOL) build --tag=$(TEST_SERVER_IMG) ./test/gnmi

  docker-run-test-gnmi-server: FORCE docker-build-test-gnmi-server
    @printf "\e[1;36m>> $(CONTAINER_TOOL) run -p 8000:8000 -p 9339:9339 $(TEST_SERVER_IMG)\e[0m\n"
    @$(CONTAINER_TOOL) run --rm -p 8000:8000 -p 9339:9339 $(TEST_SERVER_IMG)

  # TEST_LAB_IMG defines the image to used for packaging the lab tests.
  TEST_LAB_IMG ?= ghcr.io/ironcore-dev/network-operator-lab-test:latest

  test-lab: FORCE
    @printf "\e[1;36m>> go test ./test/lab/ -v\e[0m\n"
    @go test ./test/lab/ -v

  docker-build-test-lab: FORCE
    @printf "\e[1;36m>> $(CONTAINER_TOOL) build --file=test/lab/Dockerfile --tag=$(TEST_LAB_IMG) .\e[0m\n"
    @$(CONTAINER_TOOL) build --file=test/lab/Dockerfile --tag=$(TEST_LAB_IMG) .

  docker-push-test-lab: FORCE docker-push-test-lab
    @printf "\e[1;36m>> $(CONTAINER_TOOL) push $(TEST_LAB_IMG)\e[0m\n"
    @$(CONTAINER_TOOL) push $(TEST_LAB_IMG)
